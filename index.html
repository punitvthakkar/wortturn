<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deutsch Quiz - Wer wird Sprachmeister?</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --nintendo-blue: #0066CC;
            --nintendo-red: #FF3366;
            --nintendo-yellow: #FFCC00;
            --nintendo-green: #00CC66;
            --nintendo-orange: #FF6600;
            --nintendo-purple: #6633CC;
            --nintendo-dark-blue: #003366;
            --nintendo-light-blue: #3399FF;
            --nintendo-white: #FFFFFF;
            --nintendo-black: #000000;
            --nintendo-gray: #999999;
            --nintendo-dark-gray: #333333;
            --correct: #00FF00;
            --wrong: #FF0000;
            --lifeline: #FFAA00;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(45deg, var(--nintendo-blue) 0%, var(--nintendo-dark-blue) 50%, var(--nintendo-blue) 100%);
            background-size: 200% 200%;
            animation: gradientShift 4s ease infinite;
            color: var(--nintendo-white);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--nintendo-black);
            border: 4px solid var(--nintendo-white);
            border-radius: 0;
            padding: 20px;
            position: relative;
            box-shadow: 
                0 0 0 4px var(--nintendo-red),
                0 0 0 8px var(--nintendo-yellow);
        }

        .title {
            font-size: clamp(12px, 3vw, 20px);
            color: var(--nintendo-yellow);
            text-shadow: 
                2px 2px 0px var(--nintendo-red),
                4px 4px 0px var(--nintendo-dark-blue);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: clamp(8px, 2vw, 12px);
            color: var(--nintendo-light-blue);
            letter-spacing: 2px;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--nintendo-red);
            border: 3px solid var(--nintendo-white);
            color: var(--nintendo-white);
            padding: 12px 16px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(8px, 1.5vw, 10px);
            transition: all 0.1s ease;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                inset -2px -2px 0px var(--nintendo-dark-gray),
                inset 2px 2px 0px var(--nintendo-white);
        }

        .tab-btn:hover {
            background: var(--nintendo-orange);
            transform: translate(-1px, -1px);
        }

        .tab-btn:active, .tab-btn.active {
            background: var(--nintendo-yellow);
            color: var(--nintendo-black);
            transform: translate(1px, 1px);
            box-shadow: 
                inset 2px 2px 0px var(--nintendo-dark-gray),
                inset -2px -2px 0px var(--nintendo-white);
        }

        .tab-content {
            display: none;
            flex: 1;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .game-area {
            background: var(--nintendo-black);
            border: 4px solid var(--nintendo-white);
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 
                inset -4px -4px 0px var(--nintendo-dark-gray),
                inset 4px 4px 0px var(--nintendo-gray);
        }

        .hud {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .hud-item {
            background: var(--nintendo-dark-blue);
            border: 3px solid var(--nintendo-white);
            padding: 12px;
            text-align: center;
            position: relative;
            box-shadow: 
                inset -2px -2px 0px var(--nintendo-blue),
                inset 2px 2px 0px var(--nintendo-light-blue);
        }

        .hud-label {
            font-size: 8px;
            color: var(--nintendo-light-blue);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hud-value {
            font-size: clamp(12px, 2.5vw, 16px);
            color: var(--nintendo-yellow);
            text-shadow: 1px 1px 0px var(--nintendo-black);
        }

        .time-hud .hud-value {
            color: var(--nintendo-green);
        }

        .time-hud.warning .hud-value {
            color: var(--nintendo-red);
            animation: nintendoPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes nintendoPulse {
            from { 
                transform: scale(1);
                text-shadow: 1px 1px 0px var(--nintendo-black);
            }
            to { 
                transform: scale(1.1);
                text-shadow: 2px 2px 0px var(--nintendo-black), 0 0 10px var(--nintendo-red);
            }
        }

        .lifelines {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .lifeline-btn {
            width: 60px;
            height: 60px;
            border: 3px solid var(--nintendo-white);
            background: var(--nintendo-orange);
            color: var(--nintendo-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-family: 'Press Start 2P', monospace;
            transition: all 0.1s ease;
            position: relative;
            box-shadow: 
                inset -2px -2px 0px var(--nintendo-red),
                inset 2px 2px 0px var(--nintendo-yellow);
        }

        .lifeline-btn:hover:not(:disabled) {
            background: var(--nintendo-yellow);
            color: var(--nintendo-black);
            transform: translate(-1px, -1px);
        }

        .lifeline-btn:active:not(:disabled) {
            transform: translate(1px, 1px);
            box-shadow: 
                inset 2px 2px 0px var(--nintendo-red),
                inset -2px -2px 0px var(--nintendo-yellow);
        }

        .lifeline-btn:disabled {
            background: var(--nintendo-gray);
            border-color: var(--nintendo-dark-gray);
            color: var(--nintendo-dark-gray);
            cursor: not-allowed;
            box-shadow: 
                inset 2px 2px 0px var(--nintendo-dark-gray),
                inset -2px -2px 0px var(--nintendo-white);
        }

        .question-area {
            background: var(--nintendo-dark-blue);
            border: 4px solid var(--nintendo-white);
            padding: 25px;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            box-shadow: 
                inset -3px -3px 0px var(--nintendo-blue),
                inset 3px 3px 0px var(--nintendo-light-blue);
        }

        .question-area::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--nintendo-yellow);
            pointer-events: none;
        }

        .question-text {
            font-size: clamp(10px, 2.5vw, 14px);
            line-height: 1.8;
            color: var(--nintendo-white);
            text-shadow: 1px 1px 0px var(--nintendo-black);
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .answer-option {
            background: var(--nintendo-green);
            border: 3px solid var(--nintendo-white);
            padding: 15px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            min-height: 70px;
            position: relative;
            box-shadow: 
                inset -3px -3px 0px var(--nintendo-dark-gray),
                inset 3px 3px 0px var(--nintendo-light-blue);
        }

        .answer-option:hover:not(.disabled) {
            background: var(--nintendo-yellow);
            transform: translate(-1px, -1px);
            box-shadow: 
                inset -2px -2px 0px var(--nintendo-dark-gray),
                inset 2px 2px 0px var(--nintendo-white);
        }

        .answer-letter {
            background: var(--nintendo-red);
            color: var(--nintendo-white);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 15px;
            flex-shrink: 0;
            border: 2px solid var(--nintendo-white);
            box-shadow: 
                inset -1px -1px 0px var(--nintendo-dark-gray),
                inset 1px 1px 0px var(--nintendo-orange);
        }

        .answer-text {
            flex: 1;
            font-size: clamp(9px, 2vw, 12px);
            color: var(--nintendo-white);
            text-shadow: 1px 1px 0px var(--nintendo-black);
        }

        .answer-option.correct {
            background: var(--correct);
            animation: nintendoCorrect 0.6s ease;
            border-color: var(--nintendo-white);
        }

        .answer-option.wrong {
            background: var(--wrong);
            animation: nintendoWrong 0.6s ease;
            border-color: var(--nintendo-white);
        }

        .answer-option.eliminated {
            background: var(--nintendo-dark-gray);
            border-color: var(--nintendo-gray);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .answer-option.disabled {
            cursor: not-allowed;
        }

        @keyframes nintendoCorrect {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1.02); }
            75% { transform: scale(1.05); }
        }

        @keyframes nintendoWrong {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-5px); }
            30% { transform: translateX(5px); }
            50% { transform: translateX(-3px); }
            70% { transform: translateX(3px); }
            90% { transform: translateX(-1px); }
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .game-btn {
            background: var(--nintendo-red);
            border: 3px solid var(--nintendo-white);
            color: var(--nintendo-white);
            padding: 15px 25px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(8px, 2vw, 12px);
            transition: all 0.1s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            box-shadow: 
                inset -3px -3px 0px var(--nintendo-dark-gray),
                inset 3px 3px 0px var(--nintendo-orange);
        }

        .game-btn:hover:not(:disabled) {
            background: var(--nintendo-yellow);
            color: var(--nintendo-black);
            transform: translate(-1px, -1px);
        }

        .game-btn:active:not(:disabled) {
            transform: translate(1px, 1px);
            box-shadow: 
                inset 3px 3px 0px var(--nintendo-dark-gray),
                inset -3px -3px 0px var(--nintendo-orange);
        }

        .game-btn:disabled {
            background: var(--nintendo-gray);
            border-color: var(--nintendo-dark-gray);
            color: var(--nintendo-dark-gray);
            cursor: not-allowed;
        }

        .corrections-list, .history-list, .stats-area {
            background: var(--nintendo-black);
            border: 4px solid var(--nintendo-white);
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 
                inset -4px -4px 0px var(--nintendo-dark-gray),
                inset 4px 4px 0px var(--nintendo-gray);
        }

        .section-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: clamp(12px, 3vw, 18px);
            color: var(--nintendo-yellow);
            text-shadow: 
                2px 2px 0px var(--nintendo-red),
                4px 4px 0px var(--nintendo-dark-blue);
            letter-spacing: 1px;
        }

        .correction-item, .history-item {
            background: var(--nintendo-dark-blue);
            border: 3px solid var(--nintendo-white);
            padding: 20px;
            margin-bottom: 15px;
            border-left: 6px solid var(--nintendo-red);
            box-shadow: 
                inset -2px -2px 0px var(--nintendo-blue),
                inset 2px 2px 0px var(--nintendo-light-blue);
        }

        .history-item {
            border-left-color: var(--nintendo-yellow);
        }

        .correction-question {
            margin-bottom: 10px;
            color: var(--nintendo-white);
            font-size: 10px;
            line-height: 1.6;
        }

        .correction-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 8px;
            line-height: 1.6;
        }

        .user-answer {
            color: var(--nintendo-red);
        }

        .correct-answer {
            color: var(--nintendo-green);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--nintendo-dark-blue);
            border: 3px solid var(--nintendo-white);
            padding: 20px;
            text-align: center;
            box-shadow: 
                inset -3px -3px 0px var(--nintendo-blue),
                inset 3px 3px 0px var(--nintendo-light-blue);
        }

        .stat-value {
            font-size: clamp(14px, 3vw, 24px);
            color: var(--nintendo-yellow);
            margin-bottom: 8px;
            text-shadow: 1px 1px 0px var(--nintendo-black);
        }

        .stat-label {
            font-size: 8px;
            color: var(--nintendo-light-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: var(--nintendo-dark-blue);
            border: 3px solid var(--nintendo-white);
            padding: 25px;
            margin-top: 25px;
            box-shadow: 
                inset -3px -3px 0px var(--nintendo-blue),
                inset 3px 3px 0px var(--nintendo-light-blue);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--nintendo-black);
            border: 4px solid var(--nintendo-white);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 
                0 0 0 4px var(--nintendo-red),
                0 0 0 8px var(--nintendo-yellow),
                inset -4px -4px 0px var(--nintendo-dark-gray),
                inset 4px 4px 0px var(--nintendo-gray);
        }

        .modal-title {
            font-size: clamp(12px, 3vw, 18px);
            color: var(--nintendo-yellow);
            margin-bottom: 20px;
            text-shadow: 
                2px 2px 0px var(--nintendo-red),
                4px 4px 0px var(--nintendo-dark-blue);
        }

        .modal-text {
            margin-bottom: 25px;
            line-height: 1.8;
            font-size: 10px;
            color: var(--nintendo-white);
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--nintendo-light-blue);
            font-style: italic;
            font-size: 10px;
            line-height: 1.8;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--nintendo-light-blue);
            font-size: 10px;
        }

        /* Custom scrollbar for Nintendo feel */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--nintendo-dark-gray);
            border: 2px solid var(--nintendo-white);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--nintendo-red);
            border: 2px solid var(--nintendo-white);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--nintendo-orange);
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
            }
            
            .hud {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .lifelines {
                gap: 8px;
            }
            
            .lifeline-btn {
                width: 50px;
                height: 50px;
                font-size: 12px;
            }
            
            .correction-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .header {
                padding: 15px;
            }

            .game-area {
                padding: 15px;
            }
        }

        @media (max-height: 700px) {
            .container {
                padding: 10px;
            }
            
            .header {
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .tab-nav {
                margin-bottom: 15px;
            }
            
            .game-area {
                padding: 15px;
            }
            
            .question-area {
                min-height: 80px;
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .hud {
                margin-bottom: 15px;
            }
            
            .lifelines {
                margin-bottom: 15px;
            }
            
            .answers-grid {
                margin-bottom: 15px;
            }
        }

        /* Add some retro Nintendo sparkle effects */
        .header::after {
            content: 'â˜…';
            position: absolute;
            top: 10px;
            right: 20px;
            color: var(--nintendo-yellow);
            font-size: 16px;
            animation: sparkle 2s ease-in-out infinite;
        }

        .header::before {
            content: 'â˜…';
            position: absolute;
            top: 10px;
            left: 20px;
            color: var(--nintendo-yellow);
            font-size: 16px;
            animation: sparkle 2s ease-in-out infinite 1s;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Wer wird Sprachmeister?</h1>
            <p class="subtitle">Deutsch Quiz Challenge</p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('spiel')">Spiel</button>
            <button class="tab-btn" onclick="switchTab('fehler')">Korrekturen</button>
            <button class="tab-btn" onclick="switchTab('verlauf')">Verlauf</button>
            <button class="tab-btn" onclick="switchTab('statistik')">Statistik</button>
        </div>

        <div id="spiel" class="tab-content active">
            <div class="game-area">
                <div class="hud">
                    <div class="hud-item">
                        <div class="hud-label">Punkte</div>
                        <div class="hud-value" id="score">0</div>
                    </div>
                    <div class="hud-item">
                        <div class="hud-label">Fragen</div>
                        <div class="hud-value" id="questions-count">0</div>
                    </div>
                    <div class="hud-item time-hud" id="time-hud">
                        <div class="hud-label">Zeit</div>
                        <div class="hud-value" id="time">100</div>
                    </div>
                </div>
                
                <div class="lifelines">
                    <button class="lifeline-btn" id="fifty-fifty" onclick="useFiftyFifty()" title="50:50">50</button>
                    <button class="lifeline-btn" id="phone-friend" onclick="usePhoneFriend()" title="Telefonjoker">ðŸ“ž</button>
                    <button class="lifeline-btn" id="ask-audience" onclick="useAskAudience()" title="Publikumsjoker">ðŸ‘¥</button>
                    <button class="lifeline-btn" id="ask-expert" onclick="useAskExpert()" title="Expertenjoker">ðŸ§ </button>
                </div>
                
                <div class="question-area">
                    <div class="question-text" id="question-text">
                        Willkommen beim Deutsch Quiz!<br>
                        Klicke "Spiel Starten" um zu beginnen.
                    </div>
                </div>
                
                <div class="answers-grid" id="answers-grid">
                    <!-- Answers will be populated by JavaScript -->
                </div>
                
                <div class="game-controls">
                    <button class="game-btn" id="start-btn" onclick="startGame()">Spiel Starten</button>
                    <button class="game-btn" id="stop-btn" onclick="stopGame()" style="display:none;">Spiel Beenden</button>
                </div>
            </div>
        </div>

        <div id="fehler" class="tab-content">
            <div class="corrections-list">
                <h2 class="section-title">Deine Korrekturen</h2>
                <div id="corrections-container">
                    <!-- Corrections will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="verlauf" class="tab-content">
            <div class="history-list">
                <h2 class="section-title">Spiel Verlauf</h2>
                <div id="history-container">
                    <!-- History will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="statistik" class="tab-content">
            <div class="stats-area">
                <h2 class="section-title">Deine Statistiken</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-games">0</div>
                        <div class="stat-label">Spiele</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-score">0</div>
                        <div class="stat-label">Ã˜ Punkte</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="best-score">0</div>
                        <div class="stat-label">Beste Punkte</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Genauigkeit</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="lifeline-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="lifeline-title">Joker</h2>
            <div class="modal-text" id="lifeline-text"></div>
            <button class="game-btn" onclick="closeLifelineModal()">OK</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Spiel Beendet!</h2>
            <div class="modal-text">
                <div style="font-size: 12px; color: var(--nintendo-yellow); margin-bottom: 15px; text-shadow: 1px 1px 0px var(--nintendo-black);">
                    Punkte: <span id="final-score">0</span>
                </div>
                <div style="font-size: 10px; line-height: 1.8;">Fragen beantwortet: <span id="final-questions">0</span></div>
                <div style="font-size: 10px; line-height: 1.8;">Genauigkeit: <span id="final-accuracy">0%</span></div>
                <div style="font-size: 10px; line-height: 1.8;">Spielzeit: <span id="final-time">0</span>s</div>
            </div>
            <div style="margin-top: 20px;">
                <button class="game-btn" onclick="closeGameOverModal()">OK</button>
                <button class="game-btn" onclick="startNewGame()">Neues Spiel</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameData = null;
        let gameSession = {
            active: false,
            startTime: null,
            timeRemaining: 100,
            score: 0,
            questionsAnswered: 0,
            currentQuestion: null,
            usedWords: new Set(),
            answers: [],
            corrections: [],
            difficulty: 1,
            questionTypes: ['article', 'plural', 'translation', 'synonym', 'antonym', 'comparative', 'preterite', 'partizip'],
            typeIndex: 0,
            lifelines: {
                fiftyFifty: true,
                phoneFriend: true,
                askAudience: true,
                askExpert: true
            }
        };

        let gameTimer = null;

        // Initialize game
        document.addEventListener('DOMContentLoaded', async function() {
            await loadGameData();
            loadCorrections();
            loadHistory();
            updateStats();
        });

        // Load vocabulary data
        async function loadGameData() {
            try {
                const response = await fetch('list.json');
                if (!response.ok) throw new Error('Data load failed');
                
                const text = await response.text();
                gameData = JSON.parse(text);
                
                console.log('Game data loaded successfully');
                
                if (!gameData.core_vocabulary_A1_B1) {
                    throw new Error('Invalid data structure');
                }
                
            } catch (error) {
                console.error('Data loading error:', error);
                alert('Fehler beim Laden der Daten. Bitte laden Sie die Seite neu.');
                gameData = createFallbackData();
            }
        }

        // Fallback data in case of loading issues
        function createFallbackData() {
            return {
                core_vocabulary_A1_B1: {
                    A1: {
                        nomen: [
                            {
                                wort: "Haus",
                                artikel: "das",
                                plural: "die HÃ¤user",
                                bedeutung_en: "house",
                                synonyme_de: ["GebÃ¤ude"],
                                antonyme_de: []
                            },
                            {
                                wort: "Auto",
                                artikel: "das", 
                                plural: "die Autos",
                                bedeutung_en: "car",
                                synonyme_de: ["Wagen"],
                                antonyme_de: []
                            }
                        ],
                        verben: [
                            {
                                infinitiv: "sein",
                                praeteritum: "war",
                                partizip_ii: "gewesen",
                                bedeutung_en: "to be",
                                synonyme_de: [],
                                antonyme_de: []
                            }
                        ],
                        adjektive_adverbien: [
                            {
                                wort: "gut",
                                bedeutung_en: "good",
                                synonyme_de: ["schÃ¶n"],
                                antonyme_de: ["schlecht"]
                            }
                        ]
                    }
                }
            };
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'statistik') updateStats();
            else if (tabName === 'verlauf') loadHistory();
            else if (tabName === 'fehler') loadCorrections();
        }

        // Start game
        function startGame() {
            if (!gameData) {
                alert('Daten noch nicht geladen. Bitte warten...');
                return;
            }

            // Reset game state
            gameSession = {
                active: true,
                startTime: Date.now(),
                timeRemaining: 100,
                score: 0,
                questionsAnswered: 0,
                currentQuestion: null,
                usedWords: new Set(),
                answers: [],
                corrections: [],
                difficulty: 1,
                questionTypes: ['article', 'plural', 'translation', 'synonym', 'antonym', 'comparative', 'preterite', 'partizip'],
                typeIndex: 0,
                lifelines: {
                    fiftyFifty: true,
                    phoneFriend: true,
                    askAudience: true,
                    askExpert: true
                }
            };

            // Reset UI
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            resetLifelines();
            
            // Start timer
            startTimer();
            
            // Load first question
            nextQuestion();
        }

        // Start timer
        function startTimer() {
            gameTimer = setInterval(() => {
                gameSession.timeRemaining--;
                document.getElementById('time').textContent = gameSession.timeRemaining;
                
                const timeHud = document.getElementById('time-hud');
                if (gameSession.timeRemaining <= 20) {
                    timeHud.classList.add('warning');
                } else {
                    timeHud.classList.remove('warning');
                }
                
                if (gameSession.timeRemaining <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // Generate next question
        function nextQuestion() {
            if (!gameSession.active) return;
            
            const question = generateQuestion();
            if (!question) {
                console.error('Could not generate question');
                return;
            }
            
            gameSession.currentQuestion = question;
            gameSession.difficulty = 1 + (gameSession.questionsAnswered / 8);
            
            displayQuestion();
        }

        // Generate question based on vocabulary
        function generateQuestion() {
            const questionType = gameSession.questionTypes[gameSession.typeIndex];
            gameSession.typeIndex = (gameSession.typeIndex + 1) % gameSession.questionTypes.length;
            
            const level = getDifficultyLevel();
            
            let attempts = 0;
            while (attempts < 20) {
                let question = null;
                
                try {
                    switch (questionType) {
                        case 'article':
                            question = generateArticleQuestion(level);
                            break;
                        case 'plural':
                            question = generatePluralQuestion(level);
                            break;
                        case 'translation':
                            question = generateTranslationQuestion(level);
                            break;
                        case 'synonym':
                            question = generateSynonymQuestion(level);
                            break;
                        case 'antonym':
                            question = generateAntonymQuestion(level);
                            break;
                        case 'comparative':
                            question = generateComparativeQuestion(level);
                            break;
                        case 'preterite':
                            question = generatePreteriteQuestion(level);
                            break;
                        case 'partizip':
                            question = generatePartizipQuestion(level);
                            break;
                    }
                    
                    if (question && !gameSession.usedWords.has(question.word)) {
                        gameSession.usedWords.add(question.word);
                        return question;
                    }
                } catch (error) {
                    console.error('Question generation error:', error);
                }
                
                attempts++;
            }
            
            return generateFallbackQuestion();
        }

        function getDifficultyLevel() {
            const progress = gameSession.questionsAnswered;
            if (progress < 5) return 'A1';
            if (progress < 12) return 'A2';
            return 'B1';
        }

        function getWordsFromLevel(level, category) {
            try {
                let levelData;
                if (level === 'B1') {
                    // B1 data is at root level in JSON
                    levelData = gameData.B1;
                } else {
                    // A1 and A2 are under core_vocabulary_A1_B1
                    levelData = gameData.core_vocabulary_A1_B1[level];
                }
                
                if (!levelData || !levelData[category]) {
                    return gameData.core_vocabulary_A1_B1.A1[category] || [];
                }
                return levelData[category] || [];
            } catch (error) {
                console.error('Error getting words:', error);
                return [];
            }
        }

        function generateArticleQuestion(level) {
            const nouns = getWordsFromLevel(level, 'nomen');
            const validNouns = nouns.filter(n => n && n.artikel && n.wort);
            if (validNouns.length === 0) return null;
            
            const noun = validNouns[Math.floor(Math.random() * validNouns.length)];
            const correctAnswer = noun.artikel;
            const options = shuffleArray([correctAnswer, 'der', 'die', 'das', 'kein Artikel'].filter((item, index, arr) => arr.indexOf(item) === index)).slice(0, 4);
            
            return {
                question: `Welcher Artikel gehÃ¶rt zu "${noun.wort}"?`,
                type: 'article',
                level: level,
                correct: correctAnswer,
                options: options,
                word: noun.wort,
                explanation: `${correctAnswer} ${noun.wort} (${noun.bedeutung_en || 'German word'})`
            };
        }

        function generatePluralQuestion(level) {
            const nouns = getWordsFromLevel(level, 'nomen');
            const validNouns = nouns.filter(n => n && n.plural && n.plural !== '(kein Plural)' && n.wort);
            if (validNouns.length === 0) return null;
            
            const noun = validNouns[Math.floor(Math.random() * validNouns.length)];
            const correctAnswer = noun.plural;
            const wrongAnswers = generateWrongPlurals(noun.wort, correctAnswer);
            
            return {
                question: `Wie lautet der Plural von "${noun.wort}"?`,
                type: 'plural',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers.slice(0, 3)]),
                word: noun.wort,
                explanation: `${noun.wort} â†’ ${correctAnswer}`
            };
        }

        function generateTranslationQuestion(level) {
            const categories = ['nomen', 'verben', 'adjektive_adverbien'];
            const category = categories[Math.floor(Math.random() * categories.length)];
            const words = getWordsFromLevel(level, category);
            const validWords = words.filter(w => w && w.wort && w.bedeutung_en);
            
            if (validWords.length === 0) return null;
            
            const word = validWords[Math.floor(Math.random() * validWords.length)];
            const correctAnswer = word.bedeutung_en;
            
            let wrongAnswers = validWords
                .filter(w => w.bedeutung_en !== correctAnswer)
                .map(w => w.bedeutung_en)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            if (wrongAnswers.length < 3) {
                const fallbacks = ['house', 'good', 'bad', 'big', 'small', 'to go', 'happy', 'sad'];
                wrongAnswers = [...wrongAnswers, ...fallbacks]
                    .filter(ans => ans !== correctAnswer)
                    .slice(0, 3);
            }
            
            return {
                question: `Was bedeutet "${word.wort}" auf Englisch?`,
                type: 'translation',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers]),
                word: word.wort,
                explanation: `${word.wort} = ${correctAnswer}`
            };
        }

        function generateSynonymQuestion(level) {
            const categories = ['nomen', 'verben', 'adjektive_adverbien'];
            const category = categories[Math.floor(Math.random() * categories.length)];
            const words = getWordsFromLevel(level, category);
            const wordsWithSynonyms = words.filter(w => w && w.synonyme_de && w.synonyme_de.length > 0 && w.wort);
            
            if (wordsWithSynonyms.length === 0) return null;
            
            const word = wordsWithSynonyms[Math.floor(Math.random() * wordsWithSynonyms.length)];
            const correctAnswer = word.synonyme_de[0];
            
            const wrongAnswers = words
                .filter(w => w && w.wort && w.wort !== word.wort && !word.synonyme_de.includes(w.wort))
                .map(w => w.wort)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            return {
                question: `Welches Wort hat eine Ã¤hnliche Bedeutung wie "${word.wort}"?`,
                type: 'synonym',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers]),
                word: word.wort,
                explanation: `${word.wort} â‰ˆ ${correctAnswer}`
            };
        }

        function generateAntonymQuestion(level) {
            const categories = ['nomen', 'verben', 'adjektive_adverbien'];
            const category = categories[Math.floor(Math.random() * categories.length)];
            const words = getWordsFromLevel(level, category);
            const wordsWithAntonyms = words.filter(w => w && w.antonyme_de && w.antonyme_de.length > 0 && w.wort);
            
            if (wordsWithAntonyms.length === 0) return null;
            
            const word = wordsWithAntonyms[Math.floor(Math.random() * wordsWithAntonyms.length)];
            const correctAnswer = word.antonyme_de[0];
            
            const wrongAnswers = words
                .filter(w => w && w.wort && w.wort !== word.wort && !word.antonyme_de.includes(w.wort))
                .map(w => w.wort)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            return {
                question: `Was ist das Gegenteil von "${word.wort}"?`,
                type: 'antonym',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers]),
                word: word.wort,
                explanation: `${word.wort} â†” ${correctAnswer}`
            };
        }

        function generateComparativeQuestion(level) {
            const adjectives = getWordsFromLevel(level, 'adjektive_adverbien');
            const adjectivesWithComparative = adjectives.filter(w => w && w.steigerung && w.steigerung.komparativ && w.wort);
            
            if (adjectivesWithComparative.length === 0) return null;
            
            const adjective = adjectivesWithComparative[Math.floor(Math.random() * adjectivesWithComparative.length)];
            const correctAnswer = adjective.steigerung.komparativ;
            
            const wrongAnswers = adjectivesWithComparative
                .filter(w => w.steigerung.komparativ !== correctAnswer)
                .map(w => w.steigerung.komparativ)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            if (wrongAnswers.length < 3) {
                const fallbacks = ['grÃ¶ÃŸer', 'kleiner', 'besser', 'schlechter', 'Ã¤lter', 'jÃ¼nger'];
                wrongAnswers.push(...fallbacks.filter(f => f !== correctAnswer).slice(0, 3 - wrongAnswers.length));
            }
            
            return {
                question: `Wie lautet der Komparativ von "${adjective.wort}"?`,
                type: 'comparative',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers.slice(0, 3)]),
                word: adjective.wort,
                explanation: `${adjective.wort} â†’ ${correctAnswer}`
            };
        }

        function generatePreteriteQuestion(level) {
            const verbs = getWordsFromLevel(level, 'verben');
            const verbsWithPreterite = verbs.filter(w => w && w.praeteritum && w.infinitiv);
            
            if (verbsWithPreterite.length === 0) return null;
            
            const verb = verbsWithPreterite[Math.floor(Math.random() * verbsWithPreterite.length)];
            const correctAnswer = verb.praeteritum;
            
            const wrongAnswers = verbsWithPreterite
                .filter(w => w.praeteritum !== correctAnswer)
                .map(w => w.praeteritum)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            if (wrongAnswers.length < 3) {
                const fallbacks = ['war', 'hatte', 'ging', 'kam', 'machte', 'sagte'];
                wrongAnswers.push(...fallbacks.filter(f => f !== correctAnswer).slice(0, 3 - wrongAnswers.length));
            }
            
            return {
                question: `Wie lautet das PrÃ¤teritum von "${verb.infinitiv}"?`,
                type: 'preterite',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers.slice(0, 3)]),
                word: verb.infinitiv,
                explanation: `${verb.infinitiv} â†’ ${correctAnswer}`
            };
        }

        function generatePartizipQuestion(level) {
            const verbs = getWordsFromLevel(level, 'verben');
            const verbsWithPartizip = verbs.filter(w => w && w.partizip_ii && w.infinitiv);
            
            if (verbsWithPartizip.length === 0) return null;
            
            const verb = verbsWithPartizip[Math.floor(Math.random() * verbsWithPartizip.length)];
            const correctAnswer = verb.partizip_ii;
            
            const wrongAnswers = verbsWithPartizip
                .filter(w => w.partizip_ii !== correctAnswer)
                .map(w => w.partizip_ii)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            if (wrongAnswers.length < 3) {
                const fallbacks = ['gemacht', 'gesagt', 'gegangen', 'gekommen', 'gewesen', 'gehabt'];
                wrongAnswers.push(...fallbacks.filter(f => f !== correctAnswer).slice(0, 3 - wrongAnswers.length));
            }
            
            return {
                question: `Wie lautet das Partizip II von "${verb.infinitiv}"?`,
                type: 'partizip',
                level: level,
                correct: correctAnswer,
                options: shuffleArray([correctAnswer, ...wrongAnswers.slice(0, 3)]),
                word: verb.infinitiv,
                explanation: `${verb.infinitiv} â†’ ${correctAnswer}`
            };
        }

        function generateWrongPlurals(singular, correctPlural) {
            const endings = ['e', 'en', 'er', 's'];
            const wrongAnswers = [];
            
            endings.forEach(ending => {
                const wrong = `die ${singular}${ending}`;
                if (wrong !== correctPlural && wrongAnswers.length < 3) {
                    wrongAnswers.push(wrong);
                }
            });
            
            while (wrongAnswers.length < 3) {
                wrongAnswers.push(`die ${singular}`, `das ${singular}e`, `der ${singular}en`);
            }
            
            return wrongAnswers.slice(0, 3);
        }

        function generateFallbackQuestion() {
            const fallbacks = [
                {
                    question: "Was bedeutet 'Hallo' auf Englisch?",
                    type: 'translation',
                    level: 'A1',
                    correct: "Hello",
                    options: ["Hello", "Goodbye", "Please", "Thank you"],
                    word: "Hallo",
                    explanation: "Hallo = Hello"
                },
                {
                    question: "Welcher Artikel gehÃ¶rt zu 'Haus'?",
                    type: 'article',
                    level: 'A1',
                    correct: "das",
                    options: ["das", "der", "die", "kein Artikel"],
                    word: "Haus",
                    explanation: "das Haus (the house)"
                },
                {
                    question: "Was bedeutet 'gut' auf Englisch?",
                    type: 'translation',
                    level: 'A1',
                    correct: "good",
                    options: ["good", "bad", "big", "small"],
                    word: "gut",
                    explanation: "gut = good"
                },
                {
                    question: "Was ist das Gegenteil von 'groÃŸ'?",
                    type: 'antonym',
                    level: 'A1',
                    correct: "klein",
                    options: ["klein", "gut", "schlecht", "neu"],
                    word: "groÃŸ",
                    explanation: "groÃŸ â†” klein"
                },
                {
                    question: "Wie lautet das PrÃ¤teritum von 'sein'?",
                    type: 'preterite',
                    level: 'A1',
                    correct: "war",
                    options: ["war", "bin", "ist", "wÃ¤re"],
                    word: "sein",
                    explanation: "sein â†’ war"
                },
                {
                    question: "Wie lautet der Komparativ von 'gut'?",
                    type: 'comparative',
                    level: 'A1',
                    correct: "besser",
                    options: ["besser", "guter", "am besten", "mehr gut"],
                    word: "gut",
                    explanation: "gut â†’ besser"
                }
            ];
            
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Display question
        function displayQuestion() {
            const question = gameSession.currentQuestion;
            if (!question) return;

            document.getElementById('score').textContent = gameSession.score;
            document.getElementById('questions-count').textContent = gameSession.questionsAnswered;
            document.getElementById('question-text').textContent = question.question;

            const container = document.getElementById('answers-grid');
            container.innerHTML = '';

            const letters = ['A', 'B', 'C', 'D'];

            question.options.forEach((option, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-option';
                answerDiv.innerHTML = `
                    <div class="answer-letter">${letters[index]}</div>
                    <div class="answer-text">${option}</div>
                `;
                answerDiv.onclick = () => selectAnswer(option, answerDiv);
                answerDiv.dataset.option = option;

                container.appendChild(answerDiv);
            });
        }

        // Handle answer selection
        function selectAnswer(selectedAnswer, element) {
            if (!gameSession.active) return;
            
            const question = gameSession.currentQuestion;
            const isCorrect = selectedAnswer === question.correct;
            
            // Record answer
            const answerRecord = {
                question: question.question,
                selected: selectedAnswer,
                correct: question.correct,
                isCorrect: isCorrect,
                type: question.type,
                level: question.level,
                word: question.word,
                explanation: question.explanation,
                timestamp: new Date().toISOString()
            };
            
            gameSession.answers.push(answerRecord);
            
            if (!isCorrect) {
                gameSession.corrections.push(answerRecord);
            }

            // Update score
            if (isCorrect) {
                const basePoints = 100;
                const difficultyBonus = Math.floor(gameSession.difficulty * 50);
                const timeBonus = Math.floor(gameSession.timeRemaining / 5);
                gameSession.score += basePoints + difficultyBonus + timeBonus;
            }

            gameSession.questionsAnswered++;

            // Visual feedback
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.add('disabled');
                if (option.dataset.option === question.correct) {
                    option.classList.add('correct');
                } else if (option === element && !isCorrect) {
                    option.classList.add('wrong');
                }
            });

            // Auto advance to next question
            setTimeout(() => {
                if (gameSession.active) {
                    nextQuestion();
                }
            }, 1500);
        }

        // Stop game
        function stopGame() {
            if (confirm('MÃ¶chten Sie das Spiel wirklich beenden?')) {
                endGame();
            }
        }

        // End game
        function endGame() {
            gameSession.active = false;
            
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            saveGameData();
            showGameOverModal();
            resetGameUI();
        }

        // Show game over modal
        function showGameOverModal() {
            const totalQuestions = gameSession.questionsAnswered;
            const correctAnswers = gameSession.answers.filter(a => a.isCorrect).length;
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            const playTime = gameSession.startTime ? Math.round((Date.now() - gameSession.startTime) / 1000) : 0;
            
            document.getElementById('final-score').textContent = gameSession.score;
            document.getElementById('final-questions').textContent = totalQuestions;
            document.getElementById('final-accuracy').textContent = accuracy + '%';
            document.getElementById('final-time').textContent = playTime;
            
            document.getElementById('game-over-modal').style.display = 'flex';
        }

        function closeGameOverModal() {
            document.getElementById('game-over-modal').style.display = 'none';
        }

        function startNewGame() {
            closeGameOverModal();
            startGame();
        }

        // Reset game UI
        function resetGameUI() {
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('question-text').innerHTML = 'Willkommen beim Deutsch Quiz!<br>Klicke "Spiel Starten" um zu beginnen.';
            document.getElementById('answers-grid').innerHTML = '';
            document.getElementById('score').textContent = '0';
            document.getElementById('questions-count').textContent = '0';
            document.getElementById('time').textContent = '100';
            document.getElementById('time-hud').classList.remove('warning');
            
            resetLifelines();
        }

        // Lifeline functions
        function resetLifelines() {
            ['fifty-fifty', 'phone-friend', 'ask-audience', 'ask-expert'].forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }

        function useFiftyFifty() {
            if (!gameSession.lifelines.fiftyFifty || !gameSession.active) return;
            
            gameSession.lifelines.fiftyFifty = false;
            const btn = document.getElementById('fifty-fifty');
            btn.disabled = true;
            btn.style.opacity = '0.3';
            
            const question = gameSession.currentQuestion;
            const correctAnswer = question.correct;
            
            const answerOptions = Array.from(document.querySelectorAll('.answer-option'));
            const wrongOptions = answerOptions.filter(option => 
                option.dataset.option !== correctAnswer
            );
            
            const toEliminate = wrongOptions.sort(() => 0.5 - Math.random()).slice(0, 2);
            toEliminate.forEach(option => {
                option.classList.add('eliminated');
                option.onclick = null;
            });
            
            showLifelineModal('50:50 Joker', 'Zwei falsche Antworten wurden entfernt.');
        }

        function usePhoneFriend() {
            if (!gameSession.lifelines.phoneFriend || !gameSession.active) return;
            
            gameSession.lifelines.phoneFriend = false;
            const btn = document.getElementById('phone-friend');
            btn.disabled = true;
            btn.style.opacity = '0.3';
            
            const question = gameSession.currentQuestion;
            const letters = ['A', 'B', 'C', 'D'];
            const correctIndex = question.options.indexOf(question.correct);
            
            const isRight = Math.random() < 0.80;
            const suggestion = isRight ? letters[correctIndex] : letters[Math.floor(Math.random() * 4)];
            const confidence = isRight ? Math.floor(Math.random() * 25) + 75 : Math.floor(Math.random() * 30) + 40;
            
            showLifelineModal(
                'Telefonjoker',
                `"Hallo! Ich bin mir zu ${confidence}% sicher, dass die Antwort ${suggestion} ist. Das passt zu dem, was ich Ã¼ber Deutsche Grammatik weiÃŸ."`
            );
        }

        function useAskAudience() {
            if (!gameSession.lifelines.askAudience || !gameSession.active) return;
            
            gameSession.lifelines.askAudience = false;
            const btn = document.getElementById('ask-audience');
            btn.disabled = true;
            btn.style.opacity = '0.3';
            
            const question = gameSession.currentQuestion;
            const letters = ['A', 'B', 'C', 'D'];
            const correctIndex = question.options.indexOf(question.correct);
            
            const votes = [0, 0, 0, 0];
            let remaining = 100;
            
            votes[correctIndex] = Math.floor(Math.random() * 35) + 40;
            remaining -= votes[correctIndex];
            
            for (let i = 0; i < 4; i++) {
                if (i !== correctIndex && remaining > 0) {
                    const vote = Math.floor(Math.random() * (remaining / 2));
                    votes[i] = vote;
                    remaining -= vote;
                }
            }
            if (remaining > 0) votes[0] += remaining;
            
            const pollResults = letters.map((letter, index) => 
                `${letter}: ${votes[index]}%`
            ).join('\n');
            
            showLifelineModal(
                'Publikumsjoker',
                `Abstimmungsergebnis:\n\n${pollResults}\n\nDas Publikum hat abgestimmt!`
            );
        }

        function useAskExpert() {
            if (!gameSession.lifelines.askExpert || !gameSession.active) return;
            
            gameSession.lifelines.askExpert = false;
            const btn = document.getElementById('ask-expert');
            btn.disabled = true;
            btn.style.opacity = '0.3';
            
            const question = gameSession.currentQuestion;
            const letters = ['A', 'B', 'C', 'D'];
            const correctIndex = question.options.indexOf(question.correct);
            
            const isRight = Math.random() < 0.95;
            const suggestion = isRight ? letters[correctIndex] : letters[Math.floor(Math.random() * 4)];
            
            const advice = isRight ?
                `"Ich bin sehr sicher, dass die Antwort ${suggestion} ist. ${question.explanation || 'Das entspricht den deutschen Sprachregeln.'}"` :
                `"Ich denke, die Antwort ist ${suggestion}, aber ich bin nicht ganz sicher. Es kÃ¶nnte auch eine andere sein."`;
                
            showLifelineModal('Expertenjoker', advice);
        }

        function showLifelineModal(title, text) {
            document.getElementById('lifeline-title').textContent = title;
            document.getElementById('lifeline-text').textContent = text;
            document.getElementById('lifeline-modal').style.display = 'flex';
        }

        function closeLifelineModal() {
            document.getElementById('lifeline-modal').style.display = 'none';
        }

        // Data management
        function saveGameData() {
            const games = JSON.parse(localStorage.getItem('germanQuizGames') || '[]');
            const gameRecord = {
                id: Date.now(),
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                score: gameSession.score,
                questionsAnswered: gameSession.questionsAnswered,
                correctAnswers: gameSession.answers.filter(a => a.isCorrect).length,
                accuracy: gameSession.questionsAnswered > 0 ? 
                    Math.round((gameSession.answers.filter(a => a.isCorrect).length / gameSession.questionsAnswered) * 100) : 0,
                playTime: gameSession.startTime ? Math.round((Date.now() - gameSession.startTime) / 1000) : 0,
                answers: gameSession.answers
            };
            
            games.unshift(gameRecord);
            if (games.length > 50) games.splice(50);
            localStorage.setItem('germanQuizGames', JSON.stringify(games));
            
            const allCorrections = JSON.parse(localStorage.getItem('germanQuizCorrections') || '[]');
            allCorrections.unshift(...gameSession.corrections);
            if (allCorrections.length > 200) allCorrections.splice(200);
            localStorage.setItem('germanQuizCorrections', JSON.stringify(allCorrections));
        }

        function loadCorrections() {
            const corrections = JSON.parse(localStorage.getItem('germanQuizCorrections') || '[]');
            const container = document.getElementById('corrections-container');
            
            if (corrections.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Korrekturen vorhanden.<br>Spiele ein paar Runden, um deine Fehler zu analysieren!</div>';
                return;
            }
            
            container.innerHTML = '';
            corrections.slice(0, 50).forEach(correction => {
                const item = document.createElement('div');
                item.className = 'correction-item';
                item.innerHTML = `
                    <div class="correction-question">${correction.question}</div>
                    <div class="correction-details">
                        <div class="user-answer">Deine Antwort: ${correction.selected}</div>
                        <div class="correct-answer">Richtige Antwort: ${correction.correct}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 8px; color: var(--nintendo-light-blue);">
                        ${correction.explanation || ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function loadHistory() {
            const games = JSON.parse(localStorage.getItem('germanQuizGames') || '[]');
            const container = document.getElementById('history-container');
            
            if (games.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Spiele gespielt.<br>Starte dein erstes Spiel!</div>';
                return;
            }
            
            container.innerHTML = '';
            games.forEach(game => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="color: var(--nintendo-yellow); font-size: 10px; line-height: 1.6;">${game.date} ${game.time}</div>
                            <div style="font-size: 8px; color: var(--nintendo-light-blue); margin-top: 2px; line-height: 1.6;">
                                ${game.questionsAnswered} Fragen beantwortet
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--nintendo-yellow); font-size: 12px; line-height: 1.6;">${game.score}</div>
                            <div style="font-size: 8px; color: var(--nintendo-light-blue); line-height: 1.6;">
                                ${game.accuracy}% richtig
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 8px; color: var(--nintendo-gray); line-height: 1.6;">
                        Spielzeit: ${game.playTime}s
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateStats() {
            const games = JSON.parse(localStorage.getItem('germanQuizGames') || '[]');
            
            if (games.length === 0) {
                document.getElementById('total-games').textContent = '0';
                document.getElementById('avg-score').textContent = '0';
                document.getElementById('best-score').textContent = '0';
                document.getElementById('accuracy').textContent = '0%';
                updateChart([]);
                return;
            }
            
            const totalGames = games.length;
            const avgScore = Math.round(games.reduce((sum, game) => sum + game.score, 0) / totalGames);
            const bestScore = Math.max(...games.map(game => game.score));
            const totalCorrect = games.reduce((sum, game) => sum + game.correctAnswers, 0);
            const totalQuestions = games.reduce((sum, game) => sum + game.questionsAnswered, 0);
            const overallAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            
            document.getElementById('total-games').textContent = totalGames;
            document.getElementById('avg-score').textContent = avgScore;
            document.getElementById('best-score').textContent = bestScore;
            document.getElementById('accuracy').textContent = overallAccuracy + '%';
            
            updateChart(games);
        }

        function updateChart(games) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            if (window.chartInstance) {
                window.chartInstance.destroy();
            }
            
            if (games.length === 0) {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--nintendo-gray');
                ctx.font = '10px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('Noch keine Spiele gespielt', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const recentGames = games.slice(0, 10).reverse();
            const labels = recentGames.map((_, index) => `Spiel ${index + 1}`);
            const scores = recentGames.map(game => game.score);
            const accuracies = recentGames.map(game => game.accuracy);
            
            window.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Punkte',
                            data: scores,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-yellow'),
                            backgroundColor: 'rgba(255, 204, 0, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-yellow'),
                            pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-black'),
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Genauigkeit %',
                            data: accuracies,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-light-blue'),
                            backgroundColor: 'rgba(51, 153, 255, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-light-blue'),
                            pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-black'),
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-white'),
                                font: { family: '"Press Start 2P"', size: 8 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-white'), 
                                font: { family: '"Press Start 2P"', size: 6 } 
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Punkte',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-yellow'),
                                font: { family: '"Press Start 2P"', size: 8 }
                            },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-yellow'), 
                                font: { family: '"Press Start 2P"', size: 6 } 
                            },
                            grid: { color: 'rgba(255, 204, 0, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Genauigkeit %',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-light-blue'),
                                font: { family: '"Press Start 2P"', size: 8 }
                            },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--nintendo-light-blue'), 
                                font: { family: '"Press Start 2P"', size: 6 } 
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>